<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Theo的碎碎念收纳处</title>
  <style>
    :root { color-scheme: light; }
    body{
      margin:0;
      min-height:100svh;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(30,90,191,0.20), transparent 60%),
        radial-gradient(1000px 650px at 85% 20%, rgba(90,167,255,0.18), transparent 55%),
        radial-gradient(900px 700px at 50% 92%, rgba(231,240,255,0.80), transparent 62%),
        linear-gradient(180deg, #f7faff, #ffffff);
      overflow-x:hidden;
    }
    .wrap{max-width: 860px; margin:0 auto; padding: 18px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    h1{margin: 6px 0; font-size:22px; color: rgba(0,0,0,0.84);}
    .sub{margin:0; font-size:13px; color: rgba(0,0,0,0.52); line-height:1.6}

    .card{
      margin-top:14px;
      border-radius: 22px;
      background: rgba(255,255,255,0.74);
      border: 1px solid rgba(11,42,120,0.10);
      box-shadow: 0 24px 70px rgba(11,42,120,0.10);
      backdrop-filter: blur(14px);
      padding: 16px;
    }
    label{display:block; margin-top:12px; font-size:12px; color: rgba(0,0,0,0.55)}
    textarea{
      width:100%;
      min-height: 110px;
      resize: vertical;
      margin-top: 8px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.10);
      padding: 12px;
      font-size: 14px;
      outline: none;
      background: rgba(255,255,255,0.90);
      line-height: 1.7;
    }
    input[type=file]{margin-top:8px;}

    .btns{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;}
    button, a.btn{
      border:0;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      cursor:pointer;
      background: rgba(255,255,255,0.82);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      color: rgba(0,0,0,0.78);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      text-decoration:none;
      display:inline-block;
    }
    button.primary{
      background: linear-gradient(135deg, #0b2a78, #5aa7ff);
      color:#fff;
      font-weight:800;
    }

    .list{margin-top: 14px; display:grid; gap:10px;}
    .item{
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.68);
      padding: 12px;
    }
    .meta{font-size:12px; color: rgba(0,0,0,0.48); word-break: break-all;}
    .text{margin-top:6px; white-space: pre-wrap; font-size:14px; color: rgba(0,0,0,0.72); line-height:1.7;}
    .imgs{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;}
    .imgs img{width:110px; height:110px; object-fit:cover; border-radius:14px; border:1px solid rgba(0,0,0,0.06)}

    .note{margin-top:12px; font-size:12px; color: rgba(0,0,0,0.46); line-height:1.6}

    /* calendar */
    .calHead{margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .calTitle{font-weight:900; color: rgba(0,0,0,0.78);}
    .calGrid{margin-top:10px; display:grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap:8px;}
    .calCell{
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.60);
      padding: 10px 8px;
      min-height: 44px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position: relative;
    }
    .calCell.dim{opacity:0.45;}
    .calCell.has{background: linear-gradient(135deg, rgba(11,42,120,0.12), rgba(90,167,255,0.18)); border-color: rgba(31,102,227,0.18);}
    .calCell.today{outline: 2px solid rgba(31,102,227,0.28);}
    .calNum{font-weight:900; color: rgba(0,0,0,0.72); font-size:14px;}
    .calDot{position:absolute; right:10px; bottom:10px; width:7px; height:7px; border-radius:999px; background: rgba(31,102,227,0.65);}

    .toast{position:fixed; left:50%; bottom: 16px; transform: translateX(-50%);
      background: rgba(0,0,0,0.80); color:#fff; padding: 10px 14px; border-radius: 999px; font-size: 13px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.20); display:none; max-width: calc(100% - 24px); text-align:center;}

    @media (max-width: 560px){
      .wrap{padding: 14px;}
      .imgs img{width: 96px; height: 96px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Theo的碎碎念收纳处</h1>
        <p class="sub">记录心情、状态、生活点滴。</p>
      </div>
      <a class="btn" href="./">返回问候页</a>
    </div>

    <div class="card">
      <label>想写点什么？</label>
      <textarea id="text" placeholder="比如：今天的心情、想吃的东西、发生的小事…"></textarea>

      <label>上传照片（可多张）</label>
      <input id="photos" type="file" accept="image/*" multiple />

      <div class="btns">
        <button class="primary" id="saveGitHub">保存到 GitHub</button>
      </div>

      <div class="note">
        说明：内容会保存到 GitHub 私有仓库（由管理员配置）。页面里不放明文 token。
      </div>
    </div>

    <div class="card">
      <div class="meta">日历</div>
      <div class="calHead">
        <button id="prevM">←</button>
        <div class="calTitle" id="calTitle"></div>
        <button id="nextM">→</button>
      </div>
      <div class="calGrid" id="calGrid"></div>
      <div class="note">点日期查看当天碎碎念；有记录的日期会高亮。</div>
    </div>

    <div class="card">
      <div class="meta" id="dayTitle">已保存的记录（从仓库读取）</div>
      <div class="list" id="list"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const t = $('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(() => t.style.display = 'none', 1600);
    };

    // --- Passcode gate + encrypted token ---
    const KEY_STORAGE = 'theo_notes_write_key';

    function getPass(){
      try { return localStorage.getItem(KEY_STORAGE) || ''; } catch { return ''; }
    }
    function setPass(v){
      try { localStorage.setItem(KEY_STORAGE, v); } catch {}
    }
    function clearPass(){
      try { localStorage.removeItem(KEY_STORAGE); } catch {}
    }

    async function b64ToBytes(b64){
      const bin = atob(String(b64).replace(/\n/g,''));
      const out = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
      return out;
    }

    async function decryptToken(pass){
      const enc = await fetch('./gh-token.enc.json', { cache: 'no-store' }).then(r=>r.json());
      const salt = await b64ToBytes(enc.salt);
      const iv = await b64ToBytes(enc.iv);
      const ct = await b64ToBytes(enc.ct);
      const tag = await b64ToBytes(enc.tag);
      const data = new Uint8Array(ct.length + tag.length);
      data.set(ct, 0);
      data.set(tag, ct.length);

      const baseKey = await crypto.subtle.importKey(
        'raw',
        new TextEncoder().encode(pass),
        { name: 'PBKDF2' },
        false,
        ['deriveKey']
      );

      const aesKey = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: enc.iter || 150000, hash: 'SHA-256' },
        baseKey,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
      );

      const pt = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv },
        aesKey,
        data
      );

      return new TextDecoder('utf-8').decode(new Uint8Array(pt));
    }

    // gate overlay
    const gate = document.createElement('div');
    gate.style.cssText = 'position:fixed;inset:0;display:grid;place-items:center;padding:18px;background:rgba(255,255,255,0.55);backdrop-filter:blur(12px);z-index:99;';
    gate.innerHTML = `
      <div style="width:min(520px,100%);border-radius:22px;background:rgba(255,255,255,0.86);border:1px solid rgba(0,0,0,0.06);box-shadow:0 24px 70px rgba(0,0,0,0.12);padding:18px 16px;">
        <div style="font-size:18px;font-weight:900;color:rgba(0,0,0,0.84)">请输入口令</div>
        <div style="margin-top:8px;font-size:13px;color:rgba(0,0,0,0.55);line-height:1.6">这是一个小小的朋友专属入口～</div>
        <input id="keyInput" type="password" placeholder="口令" style="margin-top:12px;width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.12);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,0.92);" />
        <div id="keyErr" style="margin-top:10px;font-size:13px;color:#b0003a;display:none">口令不对哦～</div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button id="keyOk" class="primary" style="border:0;border-radius:999px;padding:10px 14px;font-size:14px;cursor:pointer;background:linear-gradient(135deg,#0b2a78,#5aa7ff);color:#fff;font-weight:800;">进入</button>
        </div>
      </div>
    `;

    let GH_TOKEN = '';
    const GH_OWNER = 'xcuicui';
    const GH_REPO = 'theo-notes-vault';

    async function ensurePassAndToken(){
      const tryPass = async (p) => {
        try {
          const tok = await decryptToken(p);
          // quick sanity check
          if (!tok || tok.length < 10) throw new Error('bad');
          GH_TOKEN = tok;
          setPass(p);
          return true;
        } catch {
          return false;
        }
      };

      const existing = getPass();
      if (existing) {
        const ok = await tryPass(existing);
        if (ok) return;
        clearPass();
      }

      document.body.appendChild(gate);
      const input = gate.querySelector('#keyInput');
      const err = gate.querySelector('#keyErr');
      const btn = gate.querySelector('#keyOk');

      const submit = async () => {
        err.style.display = 'none';
        const v = String(input.value || '').trim();
        if (!v) return;
        const ok = await tryPass(v);
        if (ok) {
          gate.remove();
          render();
        } else {
          err.style.display = 'block';
        }
      };

      btn.onclick = submit;
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') submit(); });
      input.focus();
    }

    // --- GitHub API helpers ---
    async function ghFetch(path, opts = {}){
      const url = `https://api.github.com${path}`;
      const res = await fetch(url, {
        ...opts,
        headers: {
          'authorization': `Bearer ${GH_TOKEN}`,
          'accept': 'application/vnd.github+json',
          'x-github-api-version': '2022-11-28',
          ...(opts.headers || {}),
        }
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`${res.status} ${t.slice(0, 200)}`);
      }
      return res.json();
    }

    async function ghPutFile(path, contentBase64, message){
      const url = `/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(path).replaceAll('%2F','/')}?ref=main`;
      let sha;
      try {
        const j = await ghFetch(url);
        sha = j && j.sha;
      } catch {}

      const putUrl = `/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(path).replaceAll('%2F','/')}`;
      return ghFetch(putUrl, {
        method: 'PUT',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ message, content: contentBase64, branch: 'main', sha }),
      });
    }

    async function ghListDir(repoPath){
      const enc = repoPath.split('/').map(encodeURIComponent).join('/');
      return ghFetch(`/repos/${GH_OWNER}/${GH_REPO}/contents/${enc}?ref=main`);
    }

    async function ghGetFile(repoPath){
      const enc = repoPath.split('/').map(encodeURIComponent).join('/');
      const j = await ghFetch(`/repos/${GH_OWNER}/${GH_REPO}/contents/${enc}?ref=main`);
      if (!j || j.type !== 'file') throw new Error('not_file');
      return { content: j.content, encoding: j.encoding };
    }

    function b64ToUtf8(b64){
      const bin = atob(String(b64).replace(/\n/g,''));
      const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
      return new TextDecoder('utf-8').decode(bytes);
    }

    async function ghTryGetJson(path){
      try {
        const f = await ghGetFile(path);
        const txt = f.encoding === 'base64' ? b64ToUtf8(f.content) : '';
        return JSON.parse(txt);
      } catch {
        return null;
      }
    }

    let notesIndex = { items: [] };
    const dayCache = new Map(); // day -> daily json

    function ymKey(y,m){ return `${y}-${String(m).padStart(2,'0')}`; }

    function renderCalendar(year, month){
      const calTitle = $('calTitle');
      const grid = $('calGrid');
      if (!calTitle || !grid) return;

      calTitle.textContent = `${year} / ${String(month).padStart(2,'0')}`;
      grid.innerHTML = '';

      const first = new Date(year, month-1, 1);
      const startDow = (first.getDay() + 6) % 7; // Monday=0
      const daysInMonth = new Date(year, month, 0).getDate();

      // days set with entries
      const hasDays = new Set();
      for (const it of (notesIndex.items || [])) {
        if (!it.day) continue;
        if (String(it.day).startsWith(ymKey(year,month))) hasDays.add(it.day);
      }

      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

      // leading blanks
      for (let i=0;i<startDow;i++) {
        const d = document.createElement('div');
        d.className = 'calCell dim';
        d.style.cursor = 'default';
        grid.appendChild(d);
      }

      for (let day=1; day<=daysInMonth; day++) {
        const dayStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const cell = document.createElement('div');
        cell.className = 'calCell' + (hasDays.has(dayStr) ? ' has' : '');
        if (dayStr === todayStr) cell.className += ' today';
        cell.innerHTML = `<div class="calNum">${day}</div>` + (hasDays.has(dayStr) ? `<div class="calDot"></div>` : '');
        cell.onclick = () => loadDay(dayStr);
        grid.appendChild(cell);
      }
    }

    async function renderDay(dayStr){
      const list = $('list');
      const title = $('dayTitle');
      if (title) title.textContent = `${dayStr} 的碎碎念`;
      if (!list) return;

      const daily = dayCache.get(dayStr) || { items: [] };
      const items = Array.isArray(daily.items) ? daily.items : [];

      list.innerHTML = '';
      if (!items.length) {
        list.innerHTML = '<div class="meta">这一天还没有记录～</div>';
        return;
      }

      for (const it of items) {
        const div = document.createElement('div');
        div.className = 'item';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = new Date(it.ts || Date.now()).toLocaleString('zh-CN');

        const text = document.createElement('div');
        text.className = 'text';
        text.textContent = it.text || '';

        div.appendChild(meta);
        if (text.textContent) div.appendChild(text);

        const imgsArr = Array.isArray(it.images) ? it.images : [];
        if (imgsArr.length) {
          const btn = document.createElement('button');
          btn.textContent = `查看照片（${imgsArr.length}）`;
          btn.style.marginTop = '10px';

          const imgs = document.createElement('div');
          imgs.className = 'imgs';
          imgs.style.display = 'none';

          btn.onclick = async () => {
            if (imgs.style.display === 'none') {
              imgs.style.display = 'flex';
              btn.textContent = '收起照片';
              if (imgs.childElementCount === 0) {
                for (const p of imgsArr.slice(0, 12)) {
                  try {
                    const imgFile = await ghGetFile(p);
                    const b64 = String(imgFile.content || '').replace(/\n/g,'');
                    const bin = atob(b64);
                    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
                    const blob = new Blob([bytes]);
                    const url = URL.createObjectURL(blob);
                    const img = document.createElement('img');
                    img.alt = 'photo';
                    img.src = url;
                    imgs.appendChild(img);
                  } catch {}
                }
              }
            } else {
              imgs.style.display = 'none';
              btn.textContent = `查看照片（${imgsArr.length}）`;
            }
          };

          div.appendChild(btn);
          div.appendChild(imgs);
        }

        list.appendChild(div);
      }
    }

    async function loadDay(dayStr){
      const list = $('list');
      if (list) list.innerHTML = '<div class="meta">正在加载当天记录…</div>';

      if (!dayCache.has(dayStr)) {
        const dailyPath = `notes/${dayStr}/entries.json`;
        const daily = (await ghTryGetJson(dailyPath)) || { day: dayStr, items: [] };
        dayCache.set(dayStr, daily);
      }
      await renderDay(dayStr);
    }

    async function renderFromGitHub(){
      // Fast path: use notes/index.json (single file)
      const index = await ghTryGetJson('notes/index.json');
      notesIndex = index && typeof index === 'object' ? index : { items: [] };

      // default month = current
      const now = new Date();
      let viewY = now.getFullYear();
      let viewM = now.getMonth() + 1;

      const prevM = $('prevM');
      const nextM = $('nextM');

      const rerender = () => {
        renderCalendar(viewY, viewM);
      };

      prevM && (prevM.onclick = () => {
        viewM -= 1;
        if (viewM <= 0) { viewM = 12; viewY -= 1; }
        rerender();
      });
      nextM && (nextM.onclick = () => {
        viewM += 1;
        if (viewM >= 13) { viewM = 1; viewY += 1; }
        rerender();
      });

      rerender();

      // auto open today's day
      const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      await loadDay(today);
    }

    async function render(){
      try { await renderFromGitHub(); }
      catch (e) {
        console.warn(e);
        $('list').innerHTML = '<div class="meta">读取失败（请确认口令正确）</div>';
      }
    }

    async function readFileAsBase64(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const dataUrl = String(r.result || '');
          const b64 = dataUrl.split(',')[1] || '';
          resolve(b64);
        };
        r.onerror = () => reject(r.error);
        r.readAsDataURL(file);
      });
    }

    async function base64Utf8(str){
      const bytes = new TextEncoder().encode(str);
      let bin = '';
      bytes.forEach(b => bin += String.fromCharCode(b));
      return btoa(bin);
    }

    $('saveGitHub').onclick = async () => {
      const text = $('text').value.trim();
      const files = Array.from($('photos').files || []);
      if (!text && files.length === 0) {
        toast('写点什么或传张照片再保存哦～');
        return;
      }

      try {
        const ts = Date.now();
        const d = new Date(ts);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const HH = String(d.getHours()).padStart(2,'0');
        const MM = String(d.getMinutes()).padStart(2,'0');
        const SS = String(d.getSeconds()).padStart(2,'0');
        const day = `${yyyy}-${mm}-${dd}`;
        const dayDir = `notes/${day}`;
        const stamp = `${HH}${MM}${SS}`;

        const imgPaths = [];
        for (let i=0;i<files.length;i++) {
          const f = files[i];
          const b64 = await readFileAsBase64(f);
          const ext = (f.name.split('.').pop() || '').toLowerCase() || (f.type==='image/jpeg'?'jpg':f.type==='image/png'?'png':'bin');
          const path = `${dayDir}/images/${stamp}-${i+1}.${ext}`;
          imgPaths.push(path);
          await ghPutFile(path, b64, `Add photo ${day} ${stamp} #${i+1}`);
        }

        // Append to daily JSON
        const dailyPath = `${dayDir}/entries.json`;
        const daily = (await ghTryGetJson(dailyPath)) || { day, items: [] };
        daily.items = Array.isArray(daily.items) ? daily.items : [];
        daily.items.unshift({ ts, text, images: imgPaths });
        await ghPutFile(dailyPath, await base64Utf8(JSON.stringify(daily, null, 2)), `Update daily entries ${day}`);

        // Update index.json (fast list)
        const idxPath = 'notes/index.json';
        const idx = (await ghTryGetJson(idxPath)) || { items: [] };
        idx.items = Array.isArray(idx.items) ? idx.items : [];
        idx.items.unshift({ ts, day, text, images: imgPaths });
        // keep recent 200
        idx.items = idx.items.slice(0, 200);
        await ghPutFile(idxPath, await base64Utf8(JSON.stringify(idx, null, 2)), `Update notes index ${day}`);

        // optimistic UI: add to top immediately
        $('text').value = '';
        $('photos').value = '';
        toast('已保存到 GitHub～');
        render();
      } catch (e) {
        toast('保存失败：' + String(e).slice(0, 120));
      }
    };

    ensurePassAndToken();
  </script>
</body>
</html>
